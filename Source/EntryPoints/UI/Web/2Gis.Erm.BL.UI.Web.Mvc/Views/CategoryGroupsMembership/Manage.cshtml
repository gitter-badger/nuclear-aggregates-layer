@model CategoryGroupMembershipViewModel

@{
    Layout = "../Shared/_CardLayout.cshtml";
}

@section CardScripts
{
    <script src="/Scripts/Ext.DoubleGis.UI.CategoryGroupsMembershipControl.js?@ThisAssembly.Build" type="text/javascript"></script>

    <script type="text/javascript">
        window.InitPage = function() {

            Ext.apply(this, {
                ViewCategoryGroups: function () {

                    var params = "dialogWidth:" + 800 + "px; dialogHeight:" + 600 + "px; status:yes; scroll:yes;resizable:yes;";
                    var url = '/Grid/View/CategoryGroup';

                    window.showModalDialog(url, null, params);
                    this.refresh();
                },
                CreateControl: function() {
                    var id = Ext.get("OrganizationUnitId").dom.value;

                    var config =
                    {
                        div: 'CategoryGroupsForOrganizationUnitDiv',

                        api:
                        {
                            read: { url: '/CategoryGroupsMembership/GetCategoryGroupsMembership', method: 'GET' },
                            update: { url: '/CategoryGroupsMembership/SetCategoryGroupsMembership', method: 'POST' }
                        },
                        baseParams: { organizationUnitId: id }
                    };

                    Ext.DoubleGis.UI.CategoryGroupsMembershipControlInstance = new Ext.DoubleGis.UI.CategoryGroupsMembershipControl(config);
                }
            });

            window.Card.on("beforebuild", function() {
                this.genericSave = function(submitMode) {
                    var card = this;

                    var onSuccess = function() {
                        card.submitMode = submitMode;
                        if (card.normalizeForm() !== false) {
                            card.postForm();
                        }
                    };

                    var onFailure = function () {
                        // TODO {all, 18.12.2013}: alert можно заменить на ext'овый messagebox
                        alert(Ext.LocalizedResources.SaveError);
                        card.Items.Toolbar.enable();
                    };

                    if (Ext.DoubleGis.UI.CategoryGroupsMembershipControlInstance) {
                        Ext.DoubleGis.UI.CategoryGroupsMembershipControlInstance.Save(onSuccess, onFailure);
                    } else {
                        onSuccess();
                    }
                };
            });

            window.Card.on('beforepost', function(card) {
                card.genericSave(card.submitMode);
                return false;
            });

            window.Card.on('afterbuild', function (card) {
                card.CreateControl();
            });
        }
    </script>
}

@section CardBody
    {

    <div class="Tab" id="MainTab" title="@BLResources.GeneralTabTitle">
        @Html.HiddenFor(m => m.Id)
        @Html.HiddenFor(m => m.OrganizationUnitId)
        <div id="CategoryGroupsForOrganizationUnitDiv"></div>
    </div>
    }