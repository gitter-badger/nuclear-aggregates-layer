@using DoubleGis.Erm.BLCore.UI.Metadata.Confirmations
@using Platform.Common.Utils
@using Platform.Model.Identities.Operations.Identity
@using Platform.Model.Identities.Operations.Identity.Generic
@model Models.GroupOperation.GroupOperationViewModel

@{
    Layout = "../Shared/_DialogLayout.cshtml";
}

@section Title { @BLResources.ActivateConfirmation }
@section TopBarTitle { @BLResources.ActivateConfirmation }
@section TopBarMessage { @string.Format(BLResources.GroupOperationTopBarMessage, Model.EntityTypeName.ToStringLocalized(EnumResources.ResourceManager, EnumResources.Culture)) }

@section PageContent
{
    <link rel="stylesheet" type="text/css" href="/Content/Progress.css?@SolutionInfo.ProductVersion.Build" />
    
    <script src="/Scripts/Ext.Ajax.syncRequest.js?@SolutionInfo.ProductVersion.Build" type="text/javascript"></script>
    <script src="/Scripts/DoubleGis.UI.GroupOperations.js?@SolutionInfo.ProductVersion.Build" type="text/javascript"></script>
    <script src="/Scripts/Tooltip.js?@SolutionInfo.ProductVersion.Build" type="text/javascript"></script>

    <script type="text/javascript">
        Ext.namespace('Ext.DoubleGis.UI.Activate');
        Ext.DoubleGis.UI.Activate.ActivateProcessor = Ext.extend(Ext.DoubleGis.UI.GroupProcessor, {
            constructor: function (config) {
                Ext.DoubleGis.UI.Activate.ActivateProcessor.superclass.constructor.call(this, config);
            },
            IsUserSettingsValid: function () {
                return true;
            },
            CreateParamsForControllerCall: function (entityId) {
                return { entityId: entityId };
            }
        });
        Ext.onReady(function () {
            Ext.getDom('PageContentCell').style["vertical-align"] = "top";

            var ids;
            if (window.dialogArguments) {
                ids = window.dialogArguments.Values ? window.dialogArguments.Values : window.dialogArguments;
            } else {
                var queryParameters = Ext.urlDecode(window.location.search.substring(1));
                ids = queryParameters.CrmIds.split(',');
            }

            var config = {
                Entities: ids, // массив id сущностей
                OperationName: '@Model.OperationName', // тип операции - Qualify, Assign, ChangeTerritory
                // TODO {all, 18.12.2013}: возможно некоректное отображение диакритики
                CloseButtonText: '@BLResources.Close', // локализованная надпись для кнопки закрыть
                // TODO {all, 18.12.2013}: возможно некоректное отображение диакритики
                // TODO {all, 18.12.2013}: ресурс можно перенести в ClientResourceStorage
                NeedToSelectOneOrMoreItemsMsg: '@BLResources.NeedToSelectOneOrMoreItems', // локализованная надпись о том что нужно выбрать один или несколько элементов
                // TODO {all, 18.12.2013}: возможно некоректное отображение диакритики
                // TODO {all, 18.12.2013}: ресурс можно перенести в ClientResourceStorage
                ResultMessageTitle: '@BLResources.GroupOperationResultsTitle', // локализованная надпись - заголовок для результатов операции
                // TODO {all, 18.12.2013}: возможно некоректное отображение диакритики
                // TODO {all, 18.12.2013}: ресурс можно перенести в ClientResourceStorage
                ResultMessageTemplate: '@BLResources.GroupOperationResultsMessage' // локализованная надпись - шаблон строки для результатов операции
            };
            var activateProcessor = new Ext.DoubleGis.UI.Activate.ActivateProcessor(config);
            if (!activateProcessor.CheckProcessingPossibility()){
                return;
            }
            activateProcessor.Process();
        });
    </script>
    <table cellspacing="5" cellpadding="5" width="100%" height="100px">
        <tr>
            <td colspan="2">
                <div style="height: 30px;" id="Notifications" 
                        onmouseover="AddTooltip(@Model.Message);" 
                        onmouseout="RemoveTooltip();">
                    @Model.Message
                </div>
            </td>
        </tr>
        <tr>
            <td>
                <span id="bodyMessage" style="display: none"></span><span>
                    @ConfirmationManager.GetConfirmation(new StrictOperationIdentity(ActivateIdentity.Instance, new EntitySet(Model.EntityTypeName)))
                </span>
            </td>
        </tr>
        <tr>
            <td>
                <div id="pbDiv">
                    <div id="pbInner">
                    </div>
                </div>
            </td>
        </tr>
    </table>
    @Html.HiddenFor(x => x.EntityTypeName)
}